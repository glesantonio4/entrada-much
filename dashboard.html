<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>MUCH • Jugadas recientes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* 1. Reset básico y configuración global */
    * {
      box-sizing: border-box;
    }
    
    html {
      background-color: #f8f9fa; /* Fondo gris global */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* 2. El "Card" principal (el body) */
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #ffffff; /* Contenido en un "card" blanco */
      color: #212529;
      margin: 32px auto; /* Centrado y con margen vertical */
      padding: 24px 32px; /* Relleno interno */
      max-width: 1200px; /* Ancho máximo para legibilidad */
      border-radius: 12px; /* Esquinas redondeadas */
      box-shadow: 0 6px 20px rgba(0,0,0,0.07); /* Sombra sutil */
      line-height: 1.6;
    }

    /* 3. Tipografía y Encabezado */
    h1 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 1.75rem; /* 28px */
      font-weight: 700;
    }

    /* 4. Mensaje de Estado (Carga/Error) */
    #status {
      margin-bottom: 24px; /* Más espacio antes de la tabla */
      white-space: pre-line;
      font-size: 0.95rem;
      color: #495057; /* Un gris más oscuro */
      background-color: #f3f4f6;
      padding: 12px 16px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    #status:empty { 
      display: none; 
    }

    /* 5. Estilo de la Tabla */
    table {
      width: 100%;
      border-collapse: collapse;
      /* Enmarcamos la tabla sutilmente */
      border: 1px solid #dee2e6;
      border-radius: 8px;
      overflow: hidden; /* Clave para que el border-radius funcione en las esquinas */
    }

    /* 6. Encabezados de Tabla (thead) */
    thead {
      background-color: #f8f9fa; /* Fondo sutil para la cabecera */
    }
    th {
      padding: 12px 16px;
      border-bottom: 2px solid #dee2e6; /* Línea más gruesa para separar */
      font-size: 0.75rem; /* 12px */
      font-weight: 600;
      color: #495057;
      text-align: left;
      text-transform: uppercase; /* Estilo profesional */
      letter-spacing: 0.5px;
    }

    /* 7. Cuerpo de la Tabla (tbody) */
    td {
      padding: 14px 16px; /* Padding vertical más grande en celdas */
      border-bottom: 1px solid #e9ecef; /* Línea de separación suave */
      font-size: 0.9rem; /* 14.4px */
      color: #343a40;
      text-align: left;
    }
    
    /* Quitamos el borde de la última fila */
    tbody tr:last-child td {
      border-bottom: 0;
    }

    /* Efecto hover sutil en las filas */
    tbody tr:hover {
      background-color: #f1f3f5;
    }

    /* 8. Estilo del .pill (ya estaba bien, solo refinamos) */
    .pill {
      padding: 4px 10px;
      border-radius: 12px;
      background-color: #e9ecef;
      color: #495057;
      display: inline-block;
      font-size: 0.8rem; /* 12.8px */
      font-weight: 500;
      font-family: system-ui; /* Aseguramos que no sea monoespaciada */
    }
    
    /* Estilo para IDs (participante) */
    td:nth-child(3) {
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
      color: #005a9e;
      font-size: 0.85rem;
    }
    
    /* 9. Responsividad */
    @media (max-width: 768px) {
      /* En móvil, el body-card se pega a los bordes */
      body {
        margin: 0;
        padding: 16px;
        border-radius: 0;
        box-shadow: none;
        /* El body se vuelve transparente, el fondo es el 'html' */
        background-color: #f8f9fa; 
      }
      
      h1 { font-size: 1.6rem; }
      #status { margin-bottom: 16px; }

      /* Hacemos que la tabla sea el "card" en móvil */
      table {
        display: block; /* <-- La clave para el scroll */
        overflow-x: auto; /* <-- Permite scroll horizontal */
        white-space: nowrap; /* <-- Evita que el texto se parta */
        background-color: #ffffff; /* Fondo blanco para la tabla */
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); /* Sombra para la tabla */
      }
      
      th, td {
        /* Re-ajustamos white-space para que funcione bien */
        white-space: nowrap; 
      }
      /* Permitimos que la fecha sí se parta si es necesario */
      th:first-child, td:first-child {
        white-space: normal;
      }
    }

  </style>
</head>
<body>
  <h1>Jugadas recientes</h1>
  <p id="status">Cargando…</p>
  <table id="tabla" style="display:none">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Sala ID</th>
        <th>Participante</th>
        <th>Puntaje</th>
        <th>Correctas / Total</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    // Mostrar cualquier error JS directamente en la página
    const statusEl = document.getElementById('status');
    window.addEventListener('error', (e) => {
      statusEl.textContent = '⚠️ Error de script: ' + (e?.message || e);
      console.error(e);
    });
    window.addEventListener('unhandledrejection', (e) => {
      statusEl.textContent = '⚠️ Error no controlado: ' + (e?.reason?.message || e?.reason || e);
      console.error(e);
    });
  </script>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://qwgaeorsymfispmtsbut.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3Z2Flb3JzeW1maXNwbXRzYnV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzODcyODUsImV4cCI6MjA3Nzk2MzI4NX0.FThZIIpz3daC9u8QaKyRTpxUeW0v4QHs5sHX2s1U1eo';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const status = document.getElementById('status');
    const tabla = document.getElementById('tabla');
    const tbody = document.getElementById('tbody');

    const fmt = iso => iso ? new Date(iso).toLocaleString() : '—';

    async function cargar() {
      try {
        // ping rápido para verificar conexión
        const ping = await supabase.from('quizzes').select('id').limit(1);
        if (ping.error) {
          status.textContent = '❌ No se pudo consultar la BD (quizzes): ' + ping.error.message;
          console.error(ping.error);
          return;
        }

        // 1) Quizzes
        const { data: quizzes, error } = await supabase
          .from('quizzes')
          .select('id, sala_id, participante_id, started_at, puntaje_total, num_correctas, num_preguntas')
          .order('started_at', { ascending: false })
          .limit(20);

        if (error) {
          status.textContent = '❌ Error cargando quizzes: ' + error.message;
          console.error(error);
          return;
        }

        if (!quizzes?.length) {
          status.textContent = 'Sin jugadas aún.';
          return;
        }

        const ids = quizzes.map(q => q.id);

        // 2) Respuestas (opcional y tolerante a fallo)
        let respByQuiz = {};
        try {
          const { data: resps, error: errR } = await supabase
            .from('respuestas')
            .select('quiz_id, es_correcta')
            .in('quiz_id', ids);

          if (!errR && Array.isArray(resps)) {
            for (const r of resps) {
              (respByQuiz[r.quiz_id] ??= []).push(r);
            }
          } else if (errR) {
            console.warn('Aviso: no se pudo leer respuestas:', errR.message);
          }
        } catch (e) {
          console.warn('Aviso: tabla respuestas no disponible o error:', e);
        }

        // 3) Boletos (opcional)
        let ticketByQuiz = {};
        try {
          const { data: bols, error: errB } = await supabase
            .from('boletos') // cambia aquí si tu tabla tiene otro nombre
            .select('quiz_id, folio, premio')
            .in('quiz_id', ids);

          if (!errB && Array.isArray(bols)) {
            for (const b of bols) ticketByQuiz[b.quiz_id] = b;
          } else if (errB) {
            console.warn('Aviso: no se pudo leer boletos:', errB.message);
          }
        } catch (e) {
          console.warn('Aviso: tabla boletos no disponible o error:', e);
        }

        // 4) Render
        status.style.display = 'none';
        tabla.style.display = ''; // El CSS se encargará del 'display' real
        tbody.innerHTML = quizzes.map(q => {
          const resp = respByQuiz[q.id] ?? [];
          const total = q.num_preguntas ?? (resp.length || 0);
          const correctas =
            q.num_correctas ??
            (resp.filter(r => r.es_correcta === true).length || 0);
          const puntaje =
            q.puntaje_total ??
            (total > 0 ? Math.round((correctas / total) * 100) : 0);

          const tk = ticketByQuiz[q.id] || {};
          const premioFolio = tk.folio ? ` • <strong>${tk.premio ?? ''}</strong> • ${tk.folio}` : '';

          return `<tr>
            <td>${fmt(q.started_at)}</td>
            <td><span class="pill">${q.sala_id ?? '—'}</span></td>
            <td>${q.participante_id ? String(q.participante_id).slice(0,8) : '—'}</td>
            <td>${puntaje}</td>
            <td>${correctas} / ${total}${premioFolio}</td>
          </tr>`;
        }).join('');
      } catch (e) {
        status.textContent = '❌ Error general: ' + (e?.message || e);
        console.error(e);
      }
    }

    cargar();
  </script>
</body>
</html>
