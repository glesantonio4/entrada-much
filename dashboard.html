<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>MUCH • Jugadas recientes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; padding:24px }
    h1 { margin-bottom: 8px }
    #status { margin-bottom: 16px; white-space: pre-line; }
    table { width:100%; border-collapse:collapse }
    th,td { padding:10px; border-bottom:1px solid #eee; font-size:14px }
    .pill { padding:2px 8px; border-radius:999px; background:#f3f4f6; display:inline-block }
  </style>
</head>
<body>
  <h1>Jugadas recientes</h1>
  <p id="status">Cargando…</p>
  <table id="tabla" style="display:none">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Sala ID</th>
        <th>Participante</th>
        <th>Puntaje</th>
        <th>Correctas / Total</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    // Mostrar cualquier error JS directamente en la página
    const statusEl = document.getElementById('status');
    window.addEventListener('error', (e) => {
      statusEl.textContent = '⚠️ Error de script: ' + (e?.message || e);
      console.error(e);
    });
    window.addEventListener('unhandledrejection', (e) => {
      statusEl.textContent = '⚠️ Error no controlado: ' + (e?.reason?.message || e?.reason || e);
      console.error(e);
    });
  </script>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://qwgaeorsymfispmtsbut.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3Z2Flb3JzeW1maXNwbXRzYnV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzODcyODUsImV4cCI6MjA3Nzk2MzI4NX0.FThZIIpz3daC9u8QaKyRTpxUeW0v4QHs5sHX2s1U1eo';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const status = document.getElementById('status');
    const tabla = document.getElementById('tabla');
    const tbody = document.getElementById('tbody');

    const fmt = iso => iso ? new Date(iso).toLocaleString() : '—';

    async function cargar() {
      try {
        // ping rápido para verificar conexión
        const ping = await supabase.from('quizzes').select('id').limit(1);
        if (ping.error) {
          status.textContent = '❌ No se pudo consultar la BD (quizzes): ' + ping.error.message;
          console.error(ping.error);
          return;
        }

        // 1) Quizzes
        const { data: quizzes, error } = await supabase
          .from('quizzes')
          .select('id, sala_id, participante_id, started_at, puntaje_total, num_correctas, num_preguntas')
          .order('started_at', { ascending: false })
          .limit(20);

        if (error) {
          status.textContent = '❌ Error cargando quizzes: ' + error.message;
          console.error(error);
          return;
        }

        if (!quizzes?.length) {
          status.textContent = 'Sin jugadas aún.';
          return;
        }

        const ids = quizzes.map(q => q.id);

        // 2) Respuestas (opcional y tolerante a fallo)
        let respByQuiz = {};
        try {
          const { data: resps, error: errR } = await supabase
            .from('respuestas')
            .select('quiz_id, es_correcta')
            .in('quiz_id', ids);

          if (!errR && Array.isArray(resps)) {
            for (const r of resps) {
              (respByQuiz[r.quiz_id] ??= []).push(r);
            }
          } else if (errR) {
            console.warn('Aviso: no se pudo leer respuestas:', errR.message);
          }
        } catch (e) {
          console.warn('Aviso: tabla respuestas no disponible o error:', e);
        }

        // 3) Boletos (opcional)
        let ticketByQuiz = {};
        try {
          const { data: bols, error: errB } = await supabase
            .from('boletos') // cambia aquí si tu tabla tiene otro nombre
            .select('quiz_id, folio, premio')
            .in('quiz_id', ids);

          if (!errB && Array.isArray(bols)) {
            for (const b of bols) ticketByQuiz[b.quiz_id] = b;
          } else if (errB) {
            console.warn('Aviso: no se pudo leer boletos:', errB.message);
          }
        } catch (e) {
          console.warn('Aviso: tabla boletos no disponible o error:', e);
        }

        // 4) Render
        status.style.display = 'none';
        tabla.style.display = '';
        tbody.innerHTML = quizzes.map(q => {
          const resp = respByQuiz[q.id] ?? [];
          const total = q.num_preguntas ?? (resp.length || 0);
          const correctas =
            q.num_correctas ??
            (resp.filter(r => r.es_correcta === true).length || 0);
          const puntaje =
            q.puntaje_total ??
            (total > 0 ? Math.round((correctas / total) * 100) : 0);

          const tk = ticketByQuiz[q.id] || {};
          const premioFolio = tk.folio ? ` • <strong>${tk.premio ?? ''}</strong> • ${tk.folio}` : '';

          return `<tr>
            <td>${fmt(q.started_at)}</td>
            <td><span class="pill">${q.sala_id ?? '—'}</span></td>
            <td>${q.participante_id ? String(q.participante_id).slice(0,8) : '—'}</td>
            <td>${puntaje}</td>
            <td>${correctas} / ${total}${premioFolio}</td>
          </tr>`;
        }).join('');
      } catch (e) {
        status.textContent = '❌ Error general: ' + (e?.message || e);
        console.error(e);
      }
    }

    cargar();
  </script>
</body>
</html>
