<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>MUCH • Jugadas recientes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --pill:#f3f4f6; }
    body { font-family: system-ui, Arial, sans-serif; padding:24px; }
    h1 { margin-bottom: 8px }
    #status { margin: 10px 0 16px }
    table { width:100%; border-collapse:collapse }
    th,td { padding:10px; border-bottom:1px solid #eee; font-size:14px }
    .pill { padding:2px 8px; border-radius:999px; background:var(--pill); display:inline-block }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin: 8px 0 16px }
    .btn {
      border:1px solid #ddd; background:#fff; border-radius:10px; padding:6px 10px;
      font-size:14px; cursor:pointer;
    }
    .btn.active { border-color:#111; font-weight:600; }
  </style>
</head>
<body>
  <h1>Jugadas recientes</h1>

  <!-- Botones de salas -->
  <div id="toolbar" class="toolbar"></div>

  <p id="status">Cargando…</p>
  <table id="tabla" style="display:none">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Sala</th>
        <th>Participante</th>
        <th>Puntaje</th>
        <th>Correctas / Total</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://qwgaeorsymfispmtsbut.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3Z2Flb3JzeW1maXNwbXRzYnV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzODcyODUsImV4cCI6MjA3Nzk2MzI4NX0.FThZIIpz3daC9u8QaKyRTpxUeW0v4QHs5sHX2s1U1eo';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const status = document.getElementById('status');
    const tabla = document.getElementById('tabla');
    const tbody = document.getElementById('tbody');
    const toolbar = document.getElementById('toolbar');

    // Estado de filtro actual
    let SALAS = [];              // [{id, slug, nombre}]
    let salaSlugActual = new URLSearchParams(location.search).get('sala_nombre') || null;
    let salaIdActual = null;

    // Carga lista de salas y pinta botones
    async function cargarSalasYToolbar() {
      const { data, error } = await supabase
        .from('salas')
        .select('id, slug, nombre')
        .order('nombre', { ascending: true });

      if (error) {
        status.textContent = 'Error cargando salas: ' + error.message;
        console.error(error);
        return;
      }

      SALAS = data || [];

      // Resolver salaIdActual según el slug de la URL (si viene)
      if (salaSlugActual) {
        const found = SALAS.find(s => s.slug === salaSlugActual);
        salaIdActual = found ? found.id : null;
      }

      // Pintar botones: "Todas" + cada sala
      toolbar.innerHTML = '';
      const btnTodas = document.createElement('button');
      btnTodas.className = 'btn' + (!salaIdActual ? ' active' : '');
      btnTodas.textContent = 'Todas las salas';
      btnTodas.onclick = () => setSalaFiltro(null, null);
      toolbar.appendChild(btnTodas);

      for (const s of SALAS) {
        const b = document.createElement('button');
        b.className = 'btn' + (s.id === salaIdActual ? ' active' : '');
        b.textContent = s.nombre || s.slug;
        b.onclick = () => setSalaFiltro(s.id, s.slug);
        toolbar.appendChild(b);
      }
    }

    // Cambia el filtro activo (sin recargar), actualiza la URL y vuelve a cargar la tabla
    function setSalaFiltro(id, slug) {
      salaIdActual = id;
      salaSlugActual = slug;

      // Actualizar visual
      for (const el of toolbar.querySelectorAll('.btn')) el.classList.remove('active');
      // Reaplicar la clase al botón clicado
      const labels = Array.from(toolbar.querySelectorAll('.btn')).map(b => b.textContent.trim());
      if (id === null) {
        toolbar.querySelector('.btn').classList.add('active'); // "Todas"
      } else {
        // Buscar el botón por nombre/slug mostrado
        const targetName = (SALAS.find(s => s.id === id)?.nombre || '').trim();
        const idx = labels.indexOf(targetName);
        if (idx >= 0) toolbar.querySelectorAll('.btn')[idx + 1]?.classList.add('active');
      }

      // Actualizar querystring
      const url = new URL(location.href);
      if (slug) url.searchParams.set('sala_nombre', slug);
      else url.searchParams.delete('sala_nombre');
      history.replaceState(null, '', url);

      // Recargar data
      cargarTabla();
    }

    // Carga y pinta la tabla (aplica filtro por sala si hay)
    async function cargarTabla() {
      status.style.display = '';
      status.textContent = 'Cargando…';
      tabla.style.display = 'none';
      tbody.innerHTML = '';

      // 1) Quizzes
      let query = supabase
        .from('quizzes')
        .select('id, sala_id, participante_id, started_at, puntaje_total, num_correctas, num_preguntas')
        .order('started_at', { ascending: false })
        .limit(50);

      if (salaIdActual) query = query.eq('sala_id', salaIdActual);

      const { data: quizzes, error } = await query;

      if (error) {
        status.textContent = 'Error cargando quizzes: ' + error.message;
        console.error(error);
        return;
      }

      if (!quizzes?.length) {
        status.textContent = 'Sin jugadas para este filtro.';
        return;
      }

      const ids = quizzes.map(q => q.id);

      // 2) Respuestas para calcular correctas/total si faltan
      let respByQuiz = {};
      {
        const { data: resps, error: errR } = await supabase
          .from('respuestas')
          .select('quiz_id, es_correcta')
          .in('quiz_id', ids);

        if (!errR && resps) {
          for (const r of resps) {
            (respByQuiz[r.quiz_id] ??= []).push(r);
          }
        }
      }

      // 3) Boletos (folio/premio) por quiz (opcional)
      let ticketByQuiz = {};
      {
        const { data: bols, error: errB } = await supabase
          .from('boletos')
          .select('quiz_id, folio, premio')
          .in('quiz_id', ids);

        if (!errB && bols) {
          for (const b of bols) ticketByQuiz[b.quiz_id] = b;
        }
      }

      // 4) Render
      status.style.display = 'none';
      tabla.style.display = '';
      tbody.innerHTML = quizzes.map(q => {
        const resp = respByQuiz[q.id] ?? [];
        const total = q.num_preguntas ?? (resp.length || 0);
        const correctas = q.num_correctas ?? (resp.filter(r => r.es_correcta === true).length || 0);
        const puntaje = q.puntaje_total ?? (total > 0 ? Math.round((correctas / total) * 100) : 0);
        const tk = ticketByQuiz[q.id] || {};

        const sala = SALAS.find(s => s.id === q.sala_id);
        const salaLabel = sala ? (sala.nombre || sala.slug) : (q.sala_id ?? '—');

        return `<tr>
          <td>${new Date(q.started_at).toLocaleString()}</td>
          <td><span class="pill">${salaLabel}</span></td>
          <td>${q.participante_id ? String(q.participante_id).slice(0,8) : '—'}</td>
          <td>${puntaje}</td>
          <td>${correctas} / ${total} ${tk.folio ? ` • <strong>${tk.premio}</strong> • ${tk.folio}` : ''}</td>
        </tr>`;
      }).join('');
    }

    // Boot
    await cargarSalasYToolbar();
    await cargarTabla();
  </script>
</body>
</html>
