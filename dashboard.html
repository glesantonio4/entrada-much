<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>MUCH • Jugadas recientes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#020617;
      --bg-card:#0b1120;
      --border-soft:#1f2937;
      --accent:#06b6d4;
      --accent-soft:#0ea5e9;
      --accent-strong:#d946ef;
      --text-main:#e5e7eb;
      --text-muted:#9ca3af;
      --pill-bg:#111827;
      --pill-border:#1f2937;
      --danger:#f97373;
      --success:#22c55e;
      --warning:#facc15;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 0% 0%, rgba(56,189,248,0.12), transparent 60%),
                  radial-gradient(1200px 800px at 100% 100%, rgba(244,114,182,0.18), transparent 60%),
                  var(--bg);
      color:var(--text-main);
    }

    body{
      display:flex;
      flex-direction:column;
    }

    /* Layout general */
    .page{
      max-width:1200px;
      margin:0 auto;
      padding:20px 16px 32px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand-logo{
      width:40px;
      height:40px;
      border-radius:12px;
      background:#0f172a;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:18px;
      color:var(--accent-strong);
      box-shadow:0 10px 30px rgba(15,23,42,.7);
      border:1px solid rgba(148,163,184,.4);
    }
    .brand-txt h1{
      font-size:20px;
      margin:0 0 4px;
    }
    .brand-txt p{
      margin:0;
      font-size:13px;
      color:var(--text-muted);
    }

    #status {
      margin-bottom: 0;
      white-space: pre-line;
      font-size:13px;
      color:var(--text-muted);
    }

    /* Panel de filtros */
    .filters-card{
      background:rgba(15,23,42,.9);
      border-radius:16px;
      padding:14px 14px 10px;
      border:1px solid var(--border-soft);
      display:flex;
      flex-wrap:wrap;
      gap:10px 12px;
      align-items:flex-end;
      margin-bottom:18px;
      box-shadow:0 18px 40px rgba(15,23,42,.7);
    }
    .filter-group{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:140px;
      flex:1 1 140px;
    }
    .filter-group label{
      font-size:12px;
      font-weight:600;
      color:var(--text-muted);
    }
    .filter-group select,
    .filter-group input{
      background:#020617;
      border-radius:999px;
      border:1px solid var(--border-soft);
      padding:8px 12px;
      color:var(--text-main);
      font-size:13px;
      outline:none;
    }
    .filter-group select:focus,
    .filter-group input:focus{
      border-color:var(--accent-soft);
      box-shadow:0 0 0 1px rgba(56,189,248,.5);
    }

    .btn-refresh{
      border-radius:999px;
      border:0;
      padding:9px 16px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:linear-gradient(135deg,var(--accent-soft),var(--accent-strong));
      color:#fff;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(56,189,248,.35);
      white-space:nowrap;
    }
    .btn-refresh span{
      font-size:15px;
    }

    /* Tarjetas de métricas */
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:12px;
      margin-bottom:16px;
    }
    .stat-card{
      background:rgba(15,23,42,.92);
      border-radius:16px;
      padding:12px 14px;
      border:1px solid var(--border-soft);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
    }
    .stat-label{
      font-size:12px;
      color:var(--text-muted);
      margin-bottom:4px;
    }
    .stat-value{
      font-size:20px;
      font-weight:800;
    }
    .stat-pill{
      align-self:flex-start;
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--pill-border);
      background:#111827;
      color:var(--text-muted);
    }
    .stat-pill.ok{ color:var(--success); border-color:rgba(34,197,94,.5);}
    .stat-pill.warn{ color:var(--warning); border-color:rgba(234,179,8,.5);}
    .stat-pill.bad{ color:var(--danger); border-color:rgba(248,113,113,.5);}

    /* Tabla / contenedor */
    .table-wrapper{
      margin-top:10px;
      background:rgba(15,23,42,.96);
      border-radius:16px;
      border:1px solid var(--border-soft);
      overflow:hidden;
      box-shadow:0 18px 40px rgba(15,23,42,.75);
    }
    .table-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      border-bottom:1px solid var(--border-soft);
    }
    .table-header h2{
      margin:0;
      font-size:14px;
      letter-spacing:.03em;
      text-transform:uppercase;
      color:var(--text-muted);
    }
    .chip-small{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background:#020617;
      border:1px solid var(--border-soft);
      color:var(--text-muted);
    }

    .table-scroll{
      max-height:480px;
      overflow:auto;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead{
      position:sticky;
      top:0;
      z-index:1;
      background:#020617;
    }
    th,td{
      padding:8px 10px;
      text-align:left;
      border-bottom:1px solid #1f2937;
      white-space:nowrap;
    }
    th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--text-muted);
    }
    tbody tr:nth-child(even){ background:#020617; }
    tbody tr:nth-child(odd){ background:#020617f2; }
    tbody tr:hover{
      background:rgba(56,189,248,.10);
    }

    /* Píldora que ya usabas */
    .pill {
      padding:2px 8px;
      border-radius:999px;
      background:var(--pill-bg);
      display:inline-block;
      border:1px solid var(--pill-border);
      font-size:11px;
      color:var(--text-muted);
    }

    @media (max-width:768px){
      header{
        flex-direction:column;
        align-items:flex-start;
      }
      .table-scroll{ max-height:none; }
      table{ font-size:12px; }
      th,td{ padding:6px 8px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Header PRO -->
    <header>
      <div class="brand">
        <div class="brand-logo">M</div>
        <div class="brand-txt">
          <h1>MUCH · Jugadas recientes</h1>
          <p>Panel interno para monitorear salas, participantes, puntajes y boletos.</p>
        </div>
      </div>
      <!-- El mismo status de siempre (solo cambia el lugar visual) -->
      <p id="status">Cargando…</p>
    </header>

    <!-- Filtros visuales (tu JS no los usa aún, son solo diseño por ahora) -->
    <section class="filters-card">
      <div class="filter-group">
        <label for="f-sala">Sala</label>
        <select id="f-sala">
          <option value="">Todas las salas</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="f-desde">Desde</label>
        <input type="date" id="f-desde">
      </div>

      <div class="filter-group">
        <label for="f-hasta">Hasta</label>
        <input type="date" id="f-hasta">
      </div>

      <button id="btn-refresh" class="btn-refresh">
        <span>⟳</span> Actualizar
      </button>
    </section>

    <!-- Tarjetas de métricas (de momento solo diseño; luego las podemos llenar con JS) -->
    <section class="stats-grid">
      <article class="stat-card">
        <div>
          <div class="stat-label">Quizzes jugados</div>
          <div id="stat-quizzes" class="stat-value">0</div>
        </div>
        <div class="stat-pill ok">Actividad</div>
      </article>

      <article class="stat-card">
        <div>
          <div class="stat-label">Boletos emitidos</div>
          <div id="stat-boletos" class="stat-value">0</div>
        </div>
        <div class="stat-pill warn">Taquilla</div>
      </article>

      <article class="stat-card">
        <div>
          <div class="stat-label">Participantes únicos</div>
          <div id="stat-participantes" class="stat-value">0</div>
        </div>
        <div class="stat-pill">Visitantes</div>
      </article>

      <article class="stat-card">
        <div>
          <div class="stat-label">Premios entregados</div>
          <div id="stat-premios" class="stat-value">0</div>
        </div>
        <div class="stat-pill bad">Stock</div>
      </article>
    </section>

    <!-- Tabla envuelta en contenedor PRO, pero con los mismos IDs -->
    <section class="table-wrapper">
      <div class="table-header">
        <h2>Listado de jugadas</h2>
        <div class="chip-small">
          Mostrando <span id="chip-count">0</span> registros
        </div>
      </div>

      <div class="table-scroll">
        <table id="tabla" style="display:none">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Sala ID</th>
              <th>Participante</th>
              <th>Puntaje</th>
              <th>Correctas / Total</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // Mostrar cualquier error JS directamente en la página (igual que antes)
    const statusEl = document.getElementById('status');
    window.addEventListener('error', (e) => {
      statusEl.textContent = '⚠️ Error de script: ' + (e?.message || e);
      console.error(e);
    });
    window.addEventListener('unhandledrejection', (e) => {
      statusEl.textContent = '⚠️ Error no controlado: ' + (e?.reason?.message || e?.reason || e);
      console.error(e);
    });
  </script>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://qwgaeorsymfispmtsbut.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3Z2Flb3JzeW1maXNwbXRzYnV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzODcyODUsImV4cCI6MjA3Nzk2MzI4NX0.FThZIIpz3daC9u8QaKyRTpxUeW0v4QHs5sHX2s1U1eo';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const status = document.getElementById('status');
    const tabla = document.getElementById('tabla');
    const tbody = document.getElementById('tbody');

    const fmt = iso => iso ? new Date(iso).toLocaleString() : '—';

    async function cargar() {
      try {
        // ping rápido para verificar conexión
        const ping = await supabase.from('quizzes').select('id').limit(1);
        if (ping.error) {
          status.textContent = '❌ No se pudo consultar la BD (quizzes): ' + ping.error.message;
          console.error(ping.error);
          return;
        }

        // 1) Quizzes
        const { data: quizzes, error } = await supabase
          .from('quizzes')
          .select('id, sala_id, participante_id, started_at, puntaje_total, num_correctas, num_preguntas')
          .order('started_at', { ascending: false })
          .limit(20);

        if (error) {
          status.textContent = '❌ Error cargando quizzes: ' + error.message;
          console.error(error);
          return;
        }

        if (!quizzes?.length) {
          status.textContent = 'Sin jugadas aún.';
          return;
        }

        const ids = quizzes.map(q => q.id);

        // 2) Respuestas (opcional y tolerante a fallo)
        let respByQuiz = {};
        try {
          const { data: resps, error: errR } = await supabase
            .from('respuestas')
            .select('quiz_id, es_correcta')
            .in('quiz_id', ids);

          if (!errR && Array.isArray(resps)) {
            for (const r of resps) {
              (respByQuiz[r.quiz_id] ??= []).push(r);
            }
          } else if (errR) {
            console.warn('Aviso: no se pudo leer respuestas:', errR.message);
          }
        } catch (e) {
          console.warn('Aviso: tabla respuestas no disponible o error:', e);
        }

        // 3) Boletos (opcional)
        let ticketByQuiz = {};
        try {
          const { data: bols, error: errB } = await supabase
            .from('boletos') // cambia aquí si tu tabla tiene otro nombre
            .select('quiz_id, folio, premio')
            .in('quiz_id', ids);

          if (!errB && Array.isArray(bols)) {
            for (const b of bols) ticketByQuiz[b.quiz_id] = b;
          } else if (errB) {
            console.warn('Aviso: no se pudo leer boletos:', errB.message);
          }
        } catch (e) {
          console.warn('Aviso: tabla boletos no disponible o error:', e);
        }

        // 4) Render
        status.style.display = 'none';
        tabla.style.display = '';
        tbody.innerHTML = quizzes.map(q => {
          const resp = respByQuiz[q.id] ?? [];
          const total = q.num_preguntas ?? (resp.length || 0);
          const correctas =
            q.num_correctas ?? 
            (resp.filter(r => r.es_correcta === true).length || 0);
          const puntaje =
            q.puntaje_total ?? 
            (total > 0 ? Math.round((correctas / total) * 100) : 0);

          const tk = ticketByQuiz[q.id] || {};
          const premioFolio = tk.folio ? ` • <strong>${tk.premio ?? ''}</strong> • ${tk.folio}` : '';

          return `<tr>
            <td>${fmt(q.started_at)}</td>
            <td><span class="pill">${q.sala_id ?? '—'}</span></td>
            <td>${q.participante_id ? String(q.participante_id).slice(0,8) : '—'}</td>
            <td>${puntaje}</td>
            <td>${correctas} / ${total}${premioFolio}</td>
          </tr>`;
        }).join('');

        // Actualizar contador de registros (solo diseño)
        const chipCount = document.getElementById('chip-count');
        if (chipCount) chipCount.textContent = quizzes.length;
      } catch (e) {
        status.textContent = '❌ Error general: ' + (e?.message || e);
        console.error(e);
      }
    }

    cargar();
  </script>
</body>
</html>
